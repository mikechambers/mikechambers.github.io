
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Simple Apollo Offline Caching Example - Mike Chambers</title>
  <meta name="author" content="Mike Chambers">

  
  <meta name="description" content="I have put together a very simple example of how to download and cache items to the files system. This can be useful if your application needs to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.mikechambers.com/blog/2007/03/19/simple-apollo-offline-caching-example">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mike Chambers" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>-->
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-553659-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>



<body >

<!--
<body   >
-->
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Mike Chambers</a></h1>
  
    <h2>code is beautiful</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.mikechambers.com/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Simple Apollo Offline Caching Example</h1>
    

    
      <p class="meta">
        <!--








  


<time datetime="2007-03-19T00:00:00-07:00" pubdate data-updated="true"></time>-->
        
      </p>
    
  </header>


<div class="entry-content"><p>I have put together a very simple example of how to download and cache items to the files system. This can be useful if your application needs to work offline, or if you want to optimize performance and don&#8217;t want to have to keep downloading the same assets over and over.</p>

<p>This example uses some of the caching classes from my Ascension mp3 player, and required the [corelib library][1].</p>

<p>Here is the code for the app:</p>

<!--more-->


<p>`</p>

<pre><?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute"
    creationComplete="onCreationComplete()">
    <mx:Script>
        <![CDATA[
            import com.adobe.apps.ascension.events.URLCacheEvent;
            import com.adobe.apps.ascension.utils.URLCache;
            
            private var cache:URLCache;
            private var CACHE_NAME:String = "mycache";
            
            private function onCreationComplete():void
            {
                imagePathField.text = "http://apollocamp.eventbrite.com/img/logos/47616422.png";
                
                cache = new URLCache(CACHE_NAME);
                
                cache.addEventListener(URLCacheEvent.ITEM_READY, onItemReady);
                cache.addEventListener(URLCacheEvent.ITEM_CACHED, onItemCached);
            }
            
            private function onLoadImageClick():void
            {
                if(imagePathField.text == "")
                {
                    return;
                }
                
            
                cache.cacheURL(imagePathField.text, imagePathField.text);
            }
            
            private function onItemReady(e:URLCacheEvent):void
            {
                writeToOutput("Item Ready : " + e.file.url);
                image.source = e.file.url;
            }
            
            private function onItemCached(e:URLCacheEvent):void
            {
                writeToOutput("File Cached : " + e.file.url);
            }
            
            private function writeToOutput(s:String):void
            {
                output.text += s + "\n";
            }
        ]]>
    </mx:Script>
    <mx:Button y="10" label="Load Image" right="10" click="onLoadImageClick()"/>
    <mx:Canvas right="10" left="10" top="40" bottom="114" borderColor="0xffffff" borderStyle="solid">
        <mx:Image width="100%" height="100%" id="image" scaleContent="true"/>
    </mx:Canvas>
    <mx:TextInput right="112" left="10" top="10" id="imagePathField"/>
    
    <mx:TextArea height="96" bottom="10" left="10" right="10" id="output"/>
</mx:Application>
</pre>


<p><p>`</p>

<p>Basically, the first time you load an image, you get two events. One that the item has been cached, and one that the item is ready to use. If you try to load the same image again, then you only get the item ready event, since the item has already been downloaded and cached.</p>

<p>Here is what the app looks like:</p>

<p><img src="/blog/mesh/files/CacheExample.png" height="500" with="397" border="0" alt="" /></p>

<p>Here is the main cache class:</p>

<p>`
<pre>package com.adobe.apps.ascension.utils
{</p>

<pre><code>import flash.events.EventDispatcher;
import flash.events.IEventDispatcher;
import flash.events.Event;
import flash.net.FileReference;
import flash.net.URLLoader;
import flash.net.URLRequest;
import flash.filesystem.File;
import com.adobe.crypto.MD5;
import com.adobe.net.DynamicURLLoader;
import flash.events.IOErrorEvent;
import flash.filesystem.FileStream;
import flash.filesystem.FileMode;
import com.adobe.apps.ascension.events.URLCacheEvent;
import flash.net.URLLoaderDataFormat;
import flash.utils.ByteArray;


//todo: add event metadata

public class URLCache extends EventDispatcher
{
    private var _cacheName:String;
    //maybe rename to make it clearer it loads data
    public function URLCache(cacheName:String)
    {
        _cacheName = cacheName;
    }

    public function get cacheName():String
    {
        return _cacheName;
    }

    private function getStorageDir():File
    {
        return File.appStorageDirectory.resolve(_cacheName);
    }

    public function itemExists(key:String):Boolean
    {
        return getItemFile(key).exists;
    }

    public function clearCache():void
    {
        var cacheDir:File = getStorageDir();
        try
        {
            cacheDir.deleteDirectory(true);
        }
        catch (e:IOErrorEvent)
        {
            // we tried!
        }
    }

    public function getItemFile(key:String):File
    {
        var dir:File = getStorageDir();
        var fName:String = generateKeyHash(key);
        var file:File = dir.resolve(fName);

        return file;
    }

    public function cacheURL(url:String, key:String):void
    {

        var file:File = getItemFile(key);

        //todo: do we need to check if the dir exists?

        if(file.exists)
        {
            var e:URLCacheEvent = new URLCacheEvent(URLCacheEvent.ITEM_READY);
                e.key = key;
                e.file = file;

            dispatchEvent(e);   
            return;
        }


        var loader:DynamicURLLoader = new DynamicURLLoader();
            loader.file = file;
            loader.key = key;

            loader.addEventListener(Event.COMPLETE, onDataLoad);
            loader.addEventListener(IOErrorEvent.IO_ERROR, onLoadError);

            loader.dataFormat = URLLoaderDataFormat.BINARY;

            loader.load(new URLRequest(url));

    }

    private function onLoadError(event:IOErrorEvent):void
    {
        trace("onLoadError : could not cache item");
    }

    private function onDataLoad(event:Event):void
    {
        var loader:DynamicURLLoader = DynamicURLLoader(event.target);

        var f:File = File(loader.file);
        var key:String = String(loader.key);

        var fileStream:FileStream = new FileStream();
            fileStream.open(f, FileMode.WRITE);
            fileStream.writeBytes(loader.data as ByteArray);
            fileStream.close();

            var g:URLCacheEvent = new URLCacheEvent(URLCacheEvent.ITEM_CACHED);
                g.key = key;
                g.file = f;

            dispatchEvent(g);   

            var e:URLCacheEvent = new URLCacheEvent(URLCacheEvent.ITEM_READY);
                e.key = key;
                e.file = f;

            dispatchEvent(e);   
    }


    private function generateKeyHash(key:String):String
    {
        return MD5.hash(key);
    }
}
</code></pre>

<p>}</pre>
<p>`</p>

<p>This works with any data / file types.</p>

<p>It still needs to be cleaned up some, but I wanted to get an example online asap.</p>

<p>You can download the entire example code [here][2].</p>

<p> [1]: <a href="http://code.google.com/p/as3corelib/">http://code.google.com/p/as3corelib/</a>
 [2]: /mesh/files/CacheExample.zip</p>
</div>


  <footer>
    <p class="meta">
      <!--
  

<span class="byline author vcard">Posted by <span class="fn">mikechambers</span></span>

      








  


<time datetime="2007-03-19T00:00:00-07:00" pubdate data-updated="true"></time>
-->

  

<span class="byline author vcard">Posted by <span class="fn">mikechambers</span></span>
 on 








  


<time datetime="2007-03-19T00:00:00-07:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/blog/categories/general/'>General</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="/blog//twitter.com/share" class="twitter-share-button" data-url="http://www.mikechambers.com/blog/2007/03/19/simple-apollo-offline-caching-example/" data-via="mesh" data-counturl="http://www.mikechambers.com/blog/2007/03/19/simple-apollo-offline-caching-example/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2007/03/19/lyndacom-intro-to-apollo-videos-posted-online/" title="Previous Post: Lynda.com Intro to Apollo Videos posted online">&laquo; Lynda.com Intro to Apollo Videos posted online</a>
      
      
        <a class="basic-alignment right" href="/blog/2007/03/20/yourminiscom-alpha-for-apollo/" title="Next Post: yourminis.com Alpha for Apollo">yourminis.com Alpha for Apollo &raquo;</a>
      
    </p>
  </footer>
</article>

</div>
<!--

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2013/12/14/test-post/">Test Post</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/08/simple-http-server-for-local-testing/">Simple HTTP Server for Local Testing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/02/north-american-flash-community-tour/">North American Flash Community Tour</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/22/flash-roadmap-whitepaper-published/">Flash Roadmap Whitepaper Published</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/13/in-europe-to-discuss-flash-roadmap/">In Europe to Discuss Flash Roadmap</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mikechambers">@mikechambers</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mikechambers',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>My Pinboard</h1>
  <ul id="pinboard_linkroll">Fetching linkroll...</ul>
  <p><a href="http://pinboard.in/u:mikechambers">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "mikechambers"; //id target for pinboard list
  var pinboard_count = 3; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/mikechambers@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

-->

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Mike Chambers -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mikechambers';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
