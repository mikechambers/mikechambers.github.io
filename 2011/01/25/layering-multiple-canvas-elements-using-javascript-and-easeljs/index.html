
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
	<script type="text/javascript" src="//use.typekit.net/gib0bhv.js"></script>
	<script type="text/javascript">try{Typekit.load();}catch(e){}</script>	
	
  <meta charset="utf-8">
  <title>Layering Multiple Canvas Elements Using JavaScript and EaselJS - Mike Chambers</title>
  <meta name="author" content="Mike Chambers">

  
  <meta name="description" content="If you run my EaselJS Drone Follow example from yesterday on any non-Android / iOS computer / device, you may notice that a graphic is drawn between &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mikechambers.github.io//2011/01/25/layering-multiple-canvas-elements-using-javascript-and-easeljs">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mike Chambers" type="application/atom+xml">

  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-553659-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>



<body >

<!--
<body   >
-->
  <header role="banner"><hgroup>
  <h1><a href="/">Mike Chambers</a></h1>
  
    <h2>code is beautiful</h2>
  
</hgroup>

</header>
  <nav role="navigation"><!--
<ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul> -->
<ul class="subscription">
	<li><a href="/blog/archives">about</a></li>
	<li><a href="/blog/archives">code</a></li>
	<li><a href="/blog/archives">photography</a></li>
	<li><a href="/blog/archives">twitter</a></li>
	<li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">rss</a></li>
</ul>


<!--
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mikechambers.github.io/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
-->
<ul class="main-navigation">
	<li><a href="/">home</a></li>
	<li><a href="/blog/archives">archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Layering Multiple Canvas Elements Using JavaScript and EaselJS</h1>
    

    
      <p class="meta">
        <!--








  


<time datetime="2011-01-25T12:17:01-08:00" pubdate data-updated="true">Tuesday, January 25, 2011</time>-->
        
      </p>
    
  </header>


<div class="entry-content"><p>If you run my <a href="http://www.mikechambers.com/blog/2011/01/24/easeljs-example-follow-drone/">EaselJS Drone Follow example from yesterday</a> on any non-Android / iOS computer / device, you may notice that a graphic is drawn between the mouse touch point and the current position of the drone. This is done by managing and drawing to two canvas elements and is provided to help make it clear what the drone is following (your mouse) and which direction it is currently heading.</p>

<p>Why use two canvas elements, instead of just drawing to one? Well, there are two primary reasons I architected the example like this.</p>

<!--more-->


<p>First, the main drawing canvas is persistent and is not cleared between renders. This allows me to have a single drone instance in memory (position, render, repeat) and minimize the region of the canvas that has to be rendered on any given pass. It makes it very simple to create trails of graphics, without having to instantiate and manage each individual graphic in the trail. Thus, any graphics drawn to the main canvas is permanent, and not appropriate for something like a UI overlay which needs to move, but not persist.</p>

<p>Second, and perhaps more importantly, by drawing the overlay ui on its own canvas, I can minimize the bounds of the region of each canvas that needs to be drawn on any given frame. Given that drawing to the canvas can be CPU intensive, and that the larger the drawing area, the more CPU is required, it is important to try and minimize the amount that is drawn as well as the size that is updated on any given render pass.</p>

<p>Separating the drawing canvas from the overlay canvas allows me to do this. Otherwise, I would not only have to manage the graphics for the entire canvas (in order to re-render them), but I would have to redraw all graphics on the canvas as opposed to just updating what had changed. This would lead to more complex code, higher memory requirements, as well as (sometimes) significantly higher CPU usage.</p>

<p>On the basic level, doing this in EaselJS is pretty simple. Just create two Canvas elements in your HTML document, and then create two <a href="http://easeljs.com/docs/symbols/Stage.html">Stage</a> instances that wrap them. Indeed, EaselJS adds some interesting possibilities by allowing you to easily reparent and / or clone DisplayObjects across multiple stages. However, while EaselJS made working with multiple stages pretty easy, trying to leverage two canvas elements overlaid on top each other did present some issues, which I will discuss in this post.</p>

<p><a href="http://www.mikechambers.com/blog/2011/01/24/easeljs-example-follow-drone/">View Example</a><br/>
<a href="https://github.com/mikechambers/ExamplesByMesh/tree/master/HTML5/EaselJS/follow">Download and View Code</a> (MIT License)</p>

<p>My original goal was to have the example work on both the desktop with Mouse input, as well as on iOS and Android 2.2 based touch devices.</p>

<p>In initial testing prior to adding the overlay, performance on Android and iOS devices lagged behind that on the desktop, but was still acceptable. However, as soon as I added the second canvas, performance took a huge drop on Android and iOS devices. Because of this, I had to branch my code, and only show the overlay on browsers that had a mouse based input (with an assumption that those would be regular computers with better performance).</p>

<p>Lets look at the code. First, here is the HTML markup for the example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>  <span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">&quot;mainCanvas&quot;</span> <span class="na">width=</span><span class="s">&quot;600&quot;</span> <span class="na">height=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;&lt;/canvas&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that there is only a single canvas element. At runtime, we detect the environment in which we are running, and then then dynamically add the second canvas only if it is needed (Note that the content uses <a href="http://jquery.com/">jQuery</a>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span><span class="p">((</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPad/i</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>  <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPhone/i</span><span class="p">))</span> <span class="o">||</span>
</span><span class='line'>  <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPod/i</span><span class="p">))</span> <span class="o">||</span>
</span><span class='line'>  <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/Android/i</span><span class="p">))</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">{</span>  
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//assume we are on a device with a mouse / pointer</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//we have to dynamically add the overlay canvas, because if we do it</span>
</span><span class='line'>  <span class="c1">//in HTML, and then remove it for mobile devices, it causes all of</span>
</span><span class='line'>  <span class="c1">//the drawing on the mobile devices to no be anti-aliased</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//create the overlayCanvas, and add it to the DOM after the main</span>
</span><span class='line'>  <span class="c1">//canvas (which is specified in the HTML)</span>
</span><span class='line'>  <span class="c1">//canvasWrapper is a jQUery object that wraps the main canvas element</span>
</span><span class='line'>   <span class="nx">canvasWrapper</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span>
</span><span class='line'>      <span class="s1">&#39;&lt;canvas id=&quot;overlayCanvas&quot; width=&quot;600&quot; height=&quot;400&quot;&gt;&lt;/canvas&gt;&#39;</span>
</span><span class='line'>      <span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>  <span class="c1">//overlay canvas used to draw target and line</span>
</span><span class='line'>  <span class="nx">canvasOverlayWrapper</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#overlayCanvas&quot;</span><span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//stage to manage the overlay canvas. Need to get the actual</span>
</span><span class='line'>  <span class="c1">//element from the JQuery object.</span>
</span><span class='line'>  <span class="nx">overlayStage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stage</span><span class="p">(</span><span class="nx">canvasOverlayWrapper</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>        
</span><span class='line'>
</span><span class='line'>  <span class="c1">//..</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note, that I am testing for specific devices instead of general capabilities, as in general I am branching based on known CPU performance. However, a more robust solution would probably be to quickly profile the performance of the current environment and then use the overlay only in environments that met a certain performance threshold.</p>

<p>In the code above, I detect whether I am running on an Android or iOS device and if not, I dynamically create and add the overlay canvas element to the HTML DOM. I am dynamically adding the overlay canvas as opposed to dynamically removing it, as that puts the burden of the extra work on the environment that I am more confident has better performance (the non-device environment). Further, having the overlay Canvas element in the HTML, and then removing it would require a number of additional (and unnecessary) page reflows when running on Android and iOS (which again could negatively affect performance).</p>

<p>At this point, when running on a non-Android / iOS device, I have two Canvas elements wrapped by two EaselJS Stage instances. Since I am drawing graphics on the overlay canvas based on the position of the mouse as well as a graphic on the main stage, I need to do two things:</p>

<ol>
<li>Align the two stages and ensure they stay aligned so they will share the same coordinate space.</li>
<li>Ensure that the canvas sizes remain the same when the window is resized (so graphics are not clipped in one or both stages).</li>
</ol>


<p>First, I had to add a simple CSS rule to overlay the overlay canvas on top of the main canvas, and position it at 0,0 in the document:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nf">#overlayCanvas</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">position</span><span class="o">:</span><span class="k">absolute</span><span class="p">;</span>
</span><span class='line'>  <span class="k">left</span><span class="o">:</span><span class="m">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">top</span><span class="o">:</span><span class="m">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As far as sizing, I already had code to handle resizing the main canvas based on the window resizing, so I only had to add code to also resize the overlay canvas.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//called when the browser window is resized</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">onWindowResize</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//..</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//update the canvas dimensions since the window</span>
</span><span class='line'>  <span class="c1">//has resized. Note that changing canvas dimensions, </span>
</span><span class='line'>  <span class="c1">//will cause it to be cleared</span>
</span><span class='line'>  <span class="nx">updateCanvasDimensions</span><span class="p">();</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//..</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//function that updates the size of the canvas based on the window size</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">updateCanvasDimensions</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//note that changing the canvas dimensions clears the canvas.</span>
</span><span class='line'>  <span class="nx">canvasWrapper</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
</span><span class='line'>  <span class="nx">canvasWrapper</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">width</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//save the canvas offset</span>
</span><span class='line'>  <span class="nx">canvasOffset</span> <span class="o">=</span> <span class="nx">canvasWrapper</span><span class="p">.</span><span class="nx">offset</span><span class="p">();</span> 
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//if we have an overlay canvas</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">canvasOverlayWrapper</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">//resize it</span>
</span><span class='line'>      <span class="nx">canvasOverlayWrapper</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
</span><span class='line'>      <span class="nx">canvasOverlayWrapper</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">width</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
</span><span class='line'>      <span class="nx">canvasOverlayOffset</span> <span class="o">=</span> <span class="nx">canvasOverlayWrapper</span><span class="p">.</span><span class="nx">offset</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>    
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, now both canvases are aligned, and when the window is resized they are both resized to the same dimensions.</p>

<p>Again, the importance of this is that it means that both canvases same the same coordinate space. I can use x,y coordinates from one in the other, and ensure they will be on the same spot of the screen.</p>

<p>Once I got this setup, I ran into an issue. The overlay canvas was preventing the main canvas from receiving mouse events which it needed to position the drone. This was an issue because both canvases needed to access data from the mouse events.</p>

<p>Luckily, both canvases are in the same coordinate space, so I can just listen for the mouse events on one canvas and used them on both.</p>

<p>The main change this required was changing which canvas listened for the events based on whether there was an overlay canvas or not. If there is an overlay canvas, then the overlay canvas will capture the mouse events (since it is at a higher z-order). If there is no overlay, then the main canvas will capture the mouse events.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span><span class="p">(</span>  <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPad/i</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>  <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPhone/i</span><span class="p">))</span> <span class="o">||</span>
</span><span class='line'>  <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPod/i</span><span class="p">))</span> <span class="o">||</span>
</span><span class='line'>  <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/Android/i</span><span class="p">))</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">{</span>  
</span><span class='line'>  <span class="nx">mainCanvas</span><span class="p">.</span><span class="nx">ontouchstart</span> <span class="o">=</span> <span class="nx">onTouchStart</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">mainCanvas</span><span class="p">.</span><span class="nx">ontouchend</span> <span class="o">=</span> <span class="nx">onTouchEnd</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//..</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//listen for when the mouse moves</span>
</span><span class='line'>  <span class="nx">canvasOverlayWrapper</span><span class="p">.</span><span class="nx">mousemove</span><span class="p">(</span><span class="nx">onMouseMove</span><span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//listen for a click event</span>
</span><span class='line'>  <span class="nx">canvasOverlayWrapper</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">onMouseClick</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//..</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, both canvases are aligned and in the same coordinate space, and I am receiving the relevant mouse events that I need. All I need to do now is listen for the relevant mouse events, and re-draw both canvases when the mouse position changes.</p>

<p>First, I listen for when the mouse moves:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">onMouseMove</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//update the Mouse position coordinates</span>
</span><span class='line'>  <span class="nx">updateMouseCoordinates</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//update the mouse coordinates</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">updateMouseCoordinates</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//we store these in a global object so they can be easily accessed</span>
</span><span class='line'>  <span class="c1">//from anywhere (other classes)</span>
</span><span class='line'>  <span class="nx">Mouse</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">canvasOffset</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">Mouse</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">canvasOffset</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the mouse moves, I copy the canvas relative mouse cursor coordinates into a global object. Given that hundreds of mouse events can fire a second, I try to minimize code being executed here, and don&#8217;t do any rendering updates.</p>

<p>The rendering updates occur when the EaselJS tick event is called (which in my case occurs at a target 24 frames per second).</p>

<p>Here is the tick listener for the main page:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//called at each time interval. This is essentially the listener</span>
</span><span class='line'><span class="c1">//for Tick.addListener</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">tick</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//update the main stage / canvas</span>
</span><span class='line'>  <span class="nx">stage</span><span class="p">.</span><span class="nx">tick</span><span class="p">();</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//check if we have an overlay stage</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">overlayStage</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">//update the overlay line</span>
</span><span class='line'>      <span class="nx">updateLine</span><span class="p">();</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">//re-render the overlay stage / canvas</span>
</span><span class='line'>      <span class="nx">overlayStage</span><span class="p">.</span><span class="nx">tick</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that the order of the stage.tick() calls is important. We need to update / tick the main stage first, as the overlay stage relies on properties from DisplayObjects on the main stage (and we want to make sure they have been updated before we render the overlay stage).</p>

<p>Basically, it renders the main canvas (with the new position of the drone shape), and if there is an overlayStage, re-renders the ui:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//redraws the overlay line based on Mouse and Drone position</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">updateLine</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//clear previous line</span>
</span><span class='line'>  <span class="nx">lineGraphics</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//stroke style</span>
</span><span class='line'>  <span class="nx">lineGraphics</span><span class="p">.</span><span class="nx">setStrokeStyle</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//stroke color</span>
</span><span class='line'>  <span class="nx">lineGraphics</span><span class="p">.</span><span class="nx">beginStroke</span><span class="p">(</span><span class="nx">targetColor</span><span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//draw line from Mouse position to Drone position</span>
</span><span class='line'>  <span class="nx">lineGraphics</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">Mouse</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">Mouse</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">lineGraphics</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">drone</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">drone</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>lineGraphics is a EaselJS <a href="http://easeljs.com/docs/symbols/Graphics.html">Graphics</a> instance attached to a Shape instance on the overlay stage.</p>

<p>The <a href="https://github.com/mikechambers/ExamplesByMesh/blob/master/HTML5/EaselJS/follow/scripts/Drone.js">Drone</a> instance on the main stage is also re-rendering itself on the tick event (as is the <a href="https://github.com/mikechambers/ExamplesByMesh/blob/master/HTML5/EaselJS/follow/scripts/Target.js">Target</a> instance which tracks the mouse point).</p>

<p>Here we can see how nice it is to be able to share coordinates between canvases. First, we move the drawing point on the overlay canvas to the current mouse position. We then draw a line from that point, to the coordinates for the drone, which is attached the the main canvas.</p>

<p>You may be thinking that using multiple canvases and stages like this would be any easy way to manage the z-order between graphics rendered to the canvas. You can do this, but keep in mind that changing the z-order of the canvas elements in the DOM may cause page reflows, and thus could potentially be expensive. EaselJS allows you to manage the z-order of your display list using stage.addChildAt and stage.addChild (the same as in ActionScript 3). Which technique you should use will depend on your particular project, and how often individual &ldquo;layers&rdquo; need to be updated.</p>

<p>Of course, this is a simple example. Where this could really shine is in games with complex layers of graphics, where each layer may need to be updated at differing intervals.</p>

<p>Post any questions or comments below.</p>
</div>


  <footer>
    <p class="meta">
      <!--
  

<span class="byline author vcard">Posted by <span class="fn">mikechambers</span></span>

      








  


<time datetime="2011-01-25T12:17:01-08:00" pubdate data-updated="true">Tuesday, January 25, 2011</time>
-->

  

<span class="byline author vcard">Posted by <span class="fn">mikechambers</span></span>
 on 








  


<time datetime="2011-01-25T12:17:01-08:00" pubdate data-updated="true">Tuesday, January 25, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/general/'>General</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://mikechambers.github.io//2011/01/25/layering-multiple-canvas-elements-using-javascript-and-easeljs/" data-via="mesh" data-counturl="http://mikechambers.github.io//2011/01/25/layering-multiple-canvas-elements-using-javascript-and-easeljs/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2011/01/24/easeljs-example-follow-drone/" title="Previous Post: EaselJS / Canvas Example : Follow Drone">&laquo; EaselJS / Canvas Example : Follow Drone</a>
      
      
        <a class="basic-alignment right" href="/2011/01/26/easeljs-canvas-generative-graphics-flickr-set/" title="Next Post: EaselJS / Canvas Generative Graphics Flickr Set">EaselJS / Canvas Generative Graphics Flickr Set &raquo;</a>
      
    </p>
  </footer>
</article>

</div>
<!--

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/12/14/test-post/">Test Post</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/08/simple-http-server-for-local-testing/">Simple HTTP Server for Local Testing</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/02/north-american-flash-community-tour/">North American Flash Community Tour</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/22/flash-roadmap-whitepaper-published/">Flash Roadmap Whitepaper Published</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/13/in-europe-to-discuss-flash-roadmap/">In Europe to Discuss Flash Roadmap</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mikechambers">@mikechambers</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mikechambers',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>My Pinboard</h1>
  <ul id="pinboard_linkroll">Fetching linkroll...</ul>
  <p><a href="http://pinboard.in/u:mikechambers">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "mikechambers"; //id target for pinboard list
  var pinboard_count = 3; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/mikechambers@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

-->

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Mike Chambers -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mikechambers';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
